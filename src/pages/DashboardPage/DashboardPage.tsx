import React, { useMemo, useState } from 'react';
import { useKanban } from '../../hooks/useKanbanHook';
import { UnifiedFilterProvider, useDashboardFilters } from '../../hooks/useUnifiedFilters';
import type { Board } from '../../types';
import { MetricsCards, TasksCompletedChart, TasksByStatusChart, TimeInColumnsChart } from '../../components/dashboard';
import { DashboardFilterInterface } from '../../components/dashboard';
import { UserAvatar } from '../../components/ui';
import Button from '../../components/ui/Button';
import Modal from '../../components/ui/Modal';
import './DashboardPage.css';
import { useNavigate } from 'react-router-dom';

// Componente interno que usa los filtros
const DashboardContent: React.FC = () => {
  const { boards, currentBoard } = useKanban();
  const { filters } = useDashboardFilters();
  const navigate = useNavigate();
  
  // Estado para funcionalidades administrativas
  const [showUserManagement, setShowUserManagement] = useState(false);
  const [showSystemSettings, setShowSystemSettings] = useState(false);
  const [showQuickActions, setShowQuickActions] = useState(false);
  const [showAdvancedStats, setShowAdvancedStats] = useState(false);

  // Filtrar datos seg√∫n los filtros del Dashboard
  const filteredData = useMemo(() => {
    let selectedBoard: Board | null = null;
    
    if (filters.boardId) {
      selectedBoard = boards.find(board => board.id === filters.boardId) || null;
    } else {
      selectedBoard = currentBoard;
    }

    if (!selectedBoard) return { tasks: [], boards: [] };

    // Filtrar tareas seg√∫n todos los filtros
    const filteredTasks = selectedBoard.columns.flatMap(column => 
      column.tasks.filter(task => {
        // Filtrar por estado
        if (filters.status.length > 0 && !filters.status.includes(task.status)) {
          return false;
        }

        // Filtrar por prioridad
        if (filters.priority && task.priority !== filters.priority) {
          return false;
        }

        // Filtrar por asignado
        if (filters.assignee && task.assignee !== filters.assignee) {
          return false;
        }

        // Filtrar por rango de fechas
        if (filters.dateRange.start || filters.dateRange.end) {
          const taskDate = new Date(task.createdAt);
          const startDate = filters.dateRange.start ? new Date(filters.dateRange.start) : null;
          const endDate = filters.dateRange.end ? new Date(filters.dateRange.end) : null;
          
          if (startDate && taskDate < startDate) return false;
          if (endDate && taskDate > endDate) return false;
        }

        return true;
      })
    );

    return {
      tasks: filteredTasks,
      boards: [selectedBoard]
    };
  }, [boards, currentBoard, filters]);

  return (
    <div className="dashboard-page">
      <div className="dashboard-page__header">
        <div className="dashboard-page__title-section">
          <h1 className="dashboard-page__title">üìä Dashboard de Anal√≠ticas</h1>
          <p className="dashboard-page__subtitle">
            M√©tricas y visualizaciones de tu proyecto Kanban
          </p>
        </div>
        <div className="dashboard-page__actions">
          <Button
            variant="secondary"
            size="md"
            onClick={() => navigate('/kanban')}
          >
            ‚Üê Volver al Tablero
          </Button>
        </div>
      </div>

      <div className="dashboard-page__content">
        <div className="dashboard-page__filters">
          <DashboardFilterInterface />
        </div>

        {/* Secci√≥n de Administraci√≥n */}
        <div className="dashboard-page__admin-section">
          <div className="dashboard-page__admin-header">
            <h2 className="dashboard-page__admin-title">üõ†Ô∏è Panel de Administraci√≥n</h2>
            <p className="dashboard-page__admin-subtitle">Gestiona tu equipo y configuraci√≥n</p>
          </div>
          
          <div className="dashboard-page__admin-grid">
            {/* Gesti√≥n de Usuarios */}
            <div className="dashboard-page__admin-card" onClick={() => setShowUserManagement(true)}>
              <div className="dashboard-page__admin-card-icon">üë•</div>
              <h3 className="dashboard-page__admin-card-title">Gesti√≥n de Usuarios</h3>
              <p className="dashboard-page__admin-card-description">Administra miembros del equipo y permisos</p>
              <div className="dashboard-page__admin-card-stats">
                <span className="dashboard-page__admin-card-stat">
                  <strong>8</strong> usuarios activos
                </span>
              </div>
            </div>

            {/* Configuraci√≥n del Sistema */}
            <div className="dashboard-page__admin-card" onClick={() => setShowSystemSettings(true)}>
              <div className="dashboard-page__admin-card-icon">‚öôÔ∏è</div>
              <h3 className="dashboard-page__admin-card-title">Configuraci√≥n</h3>
              <p className="dashboard-page__admin-card-description">Ajustes del sistema y preferencias</p>
              <div className="dashboard-page__admin-card-stats">
                <span className="dashboard-page__admin-card-stat">
                  <strong>{boards.length}</strong> tableros
                </span>
              </div>
            </div>

            {/* Acciones R√°pidas */}
            <div className="dashboard-page__admin-card" onClick={() => setShowQuickActions(true)}>
              <div className="dashboard-page__admin-card-icon">‚ö°</div>
              <h3 className="dashboard-page__admin-card-title">Acciones R√°pidas</h3>
              <p className="dashboard-page__admin-card-description">Herramientas y acciones frecuentes</p>
              <div className="dashboard-page__admin-card-stats">
                <span className="dashboard-page__admin-card-stat">
                  <strong>12</strong> tareas pendientes
                </span>
              </div>
            </div>

            {/* Estad√≠sticas Avanzadas */}
            <div className="dashboard-page__admin-card" onClick={() => setShowAdvancedStats(true)}>
              <div className="dashboard-page__admin-card-icon">üìä</div>
              <h3 className="dashboard-page__admin-card-title">Estad√≠sticas</h3>
              <p className="dashboard-page__admin-card-description">An√°lisis detallado y reportes</p>
              <div className="dashboard-page__admin-card-stats">
                <span className="dashboard-page__admin-card-stat">
                  <strong>95%</strong> productividad
                </span>
              </div>
            </div>
          </div>
        </div>

        <div className="dashboard-page__metrics">
          <MetricsCards tasks={filteredData.tasks} />
        </div>

        <div className="dashboard-page__charts">
          <div className="dashboard-page__chart-row">
            <TasksCompletedChart tasks={filteredData.tasks} />
            <TasksByStatusChart tasks={filteredData.tasks} />
          </div>
          <div className="dashboard-page__chart-row">
            <TimeInColumnsChart tasks={filteredData.tasks} />
          </div>
        </div>
      </div>

      {/* Modales de Administraci√≥n */}
      {showUserManagement && (
        <Modal
          isOpen={showUserManagement}
          onClose={() => setShowUserManagement(false)}
          title="üë• Gesti√≥n de Usuarios"
          size="lg"
        >
          <div className="dashboard-page__modal-content">
            <div className="dashboard-page__user-list">
              <h3>Miembros del Equipo</h3>
              <div className="dashboard-page__users-grid">
                {['Ana Garc√≠a', 'Carlos L√≥pez', 'Mar√≠a Rodr√≠guez', 'Luis Mart√≠nez', 'Sofia Chen', 'Diego Fern√°ndez', 'Elena Ruiz', 'Pablo Torres'].map((user) => (
                  <div key={user} className="dashboard-page__user-item">
                    <UserAvatar userName={user} size="md" />
                    <div className="dashboard-page__user-info">
                      <span className="dashboard-page__user-name">{user}</span>
                      <span className="dashboard-page__user-role">Miembro del equipo</span>
                    </div>
                    <div className="dashboard-page__user-actions">
                      <Button variant="secondary" size="sm">Editar</Button>
                      <Button variant="danger" size="sm">Eliminar</Button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <div className="dashboard-page__modal-actions">
              <Button variant="primary" size="md">+ Agregar Usuario</Button>
              <Button variant="secondary" size="md">Invitar por Email</Button>
            </div>
          </div>
        </Modal>
      )}

      {showSystemSettings && (
        <Modal
          isOpen={showSystemSettings}
          onClose={() => setShowSystemSettings(false)}
          title="‚öôÔ∏è Configuraci√≥n del Sistema"
          size="lg"
        >
          <div className="dashboard-page__modal-content">
            <div className="dashboard-page__settings-section">
              <h3>Configuraci√≥n General</h3>
              <div className="dashboard-page__setting-item">
                <label>Nombre de la Organizaci√≥n</label>
                <input type="text" defaultValue="Mi Empresa" className="dashboard-page__setting-input" />
              </div>
              <div className="dashboard-page__setting-item">
                <label>Zona Horaria</label>
                <select className="dashboard-page__setting-input">
                  <option>UTC-5 (Colombia)</option>
                  <option>UTC-6 (M√©xico)</option>
                  <option>UTC-3 (Argentina)</option>
                </select>
              </div>
              <div className="dashboard-page__setting-item">
                <label>Idioma</label>
                <select className="dashboard-page__setting-input">
                  <option>Espa√±ol</option>
                  <option>English</option>
                  <option>Portugu√™s</option>
                </select>
              </div>
            </div>
            <div className="dashboard-page__settings-section">
              <h3>Notificaciones</h3>
              <div className="dashboard-page__setting-item">
                <label>
                  <input type="checkbox" defaultChecked />
                  Notificaciones por email
                </label>
              </div>
              <div className="dashboard-page__setting-item">
                <label>
                  <input type="checkbox" defaultChecked />
                  Notificaciones push
                </label>
              </div>
            </div>
            <div className="dashboard-page__modal-actions">
              <Button variant="primary" size="md">Guardar Cambios</Button>
              <Button variant="secondary" size="md">Restaurar</Button>
            </div>
          </div>
        </Modal>
      )}

      {showQuickActions && (
        <Modal
          isOpen={showQuickActions}
          onClose={() => setShowQuickActions(false)}
          title="‚ö° Acciones R√°pidas"
          size="md"
        >
          <div className="dashboard-page__modal-content">
            <div className="dashboard-page__quick-actions">
              <Button variant="primary" size="lg" className="dashboard-page__quick-action">
                üìã Crear Tarea R√°pida
              </Button>
              <Button variant="secondary" size="lg" className="dashboard-page__quick-action">
                üìä Generar Reporte
              </Button>
              <Button variant="secondary" size="lg" className="dashboard-page__quick-action">
                üìß Enviar Recordatorio
              </Button>
              <Button variant="secondary" size="lg" className="dashboard-page__quick-action">
                üîÑ Sincronizar Datos
              </Button>
              <Button variant="secondary" size="lg" className="dashboard-page__quick-action">
                üì§ Exportar Datos
              </Button>
              <Button variant="secondary" size="lg" className="dashboard-page__quick-action">
                üóëÔ∏è Limpiar Completadas
              </Button>
            </div>
          </div>
        </Modal>
      )}

      {showAdvancedStats && (
        <Modal
          isOpen={showAdvancedStats}
          onClose={() => setShowAdvancedStats(false)}
          title="üìä Estad√≠sticas Avanzadas"
          size="xl"
        >
          <div className="dashboard-page__modal-content">
            <div className="dashboard-page__stats-grid">
              <div className="dashboard-page__stat-card">
                <h4>Productividad del Equipo</h4>
                <div className="dashboard-page__stat-value">95%</div>
                <div className="dashboard-page__stat-trend">‚ÜóÔ∏è +5% este mes</div>
              </div>
              <div className="dashboard-page__stat-card">
                <h4>Tiempo Promedio por Tarea</h4>
                <div className="dashboard-page__stat-value">2.3 d√≠as</div>
                <div className="dashboard-page__stat-trend">‚ÜòÔ∏è -0.5 d√≠as</div>
              </div>
              <div className="dashboard-page__stat-card">
                <h4>Tareas Completadas</h4>
                <div className="dashboard-page__stat-value">247</div>
                <div className="dashboard-page__stat-trend">‚ÜóÔ∏è +23 esta semana</div>
              </div>
              <div className="dashboard-page__stat-card">
                <h4>Eficiencia del Flujo</h4>
                <div className="dashboard-page__stat-value">87%</div>
                <div className="dashboard-page__stat-trend">‚ÜóÔ∏è +3% este mes</div>
              </div>
            </div>
            <div className="dashboard-page__modal-actions">
              <Button variant="primary" size="md">üìä Ver Reporte Completo</Button>
              <Button variant="secondary" size="md">üì§ Exportar Datos</Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};

const DashboardPage: React.FC = () => {
  const { boards } = useKanban();

  return (
    <UnifiedFilterProvider boards={boards}>
      <DashboardContent />
    </UnifiedFilterProvider>
  );
};

export default DashboardPage;
